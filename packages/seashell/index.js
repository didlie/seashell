module.exports=function(e){function t(n){if(r[n])return r[n].exports;var a=r[n]={exports:{},id:n,loaded:!1};return e[n].call(a.exports,a,a.exports,t),a.loaded=!0,a.exports}var r={};return t.m=e,t.c=r,t.p="",t(0)}([function(e,exports,t){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}Object.defineProperty(exports,"__esModule",{value:!0}),exports.Router=exports.Hub=exports.App=void 0;var n=t(1),a=r(n),o=t(20),u=r(o),c=t(13),s=r(c);exports.App=a["default"],exports.Hub=u["default"],exports.Router=s["default"]},function(e,exports,t){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}Object.defineProperty(exports,"__esModule",{value:!0});var n=t(2),a=r(n),o=t(3),u=r(o),c=t(4),s=r(c),i=t(5),l=r(i),f=t(6),d=r(f),p=t(7),h=r(p),v=t(8),S=r(v),E=t(9),x=r(E),m=t(10),b=r(m),_=t(11),k=r(_),I=t(12),w=r(I),R=t(13),g=r(R),y=t(17),O=r(y),A=function(e){function t(){var e,r,n,o,c=this;(0,S["default"])(this,t);for(var i=arguments.length,f=Array(i),p=0;i>p;p++)f[p]=arguments[p];return r=n=(0,x["default"])(this,(e=(0,h["default"])(t)).call.apply(e,[this].concat(f))),n.state={isStarted:!1,isOnline:!1,isRegistered:!1,importEmitterStack:{}},n.handleRequest=function(){var e=(0,d["default"])(s["default"].mark(function t(e){var r,a,o,u,i;return s["default"].wrap(function(t){for(;;)switch(t.prev=t.next){case 0:r=n.state.socket,a=n,o=a.handleLoop,console.log("handle request: "+(0,l["default"])(e)),u={headers:{appId:e.headers.appId,callbackId:e.headers.callbackId},end:function(){r.emit("I_HAVE_HANDLE_THIS_REQUEST",u)}},i=function c(e,t,r,n){o(e,t,r,c,n)},i(null,e,u,0);case 7:case"end":return t.stop()}},t,c)}));return function(t){return e.apply(this,arguments)}}(),n.request=function(e,t){var r=n.state,o=r.socket,c=r.importEmitterStack,s=r.appId;return new u["default"](function(r,u){try{var i=function(){if(!n.state.isOnline)return{v:u("YOUR_SERVICE_IS_OFFLINE")};var a=k["default"].v4(),i={body:t,headers:{appId:s,callbackId:a}},f=e.search("/");if(0>f)i.headers.importAppName=e,i.headers.originUrl="/";else{var d=0==f?e.substr(1):e,p=d.search("/");i.headers.importAppName=d.substring(0,p),i.headers.originUrl=d.substring(p)}console.log("Start request servicehub, data: "+(0,l["default"])(i)),c[a]=new O["default"],c[a].on("RESPONSE",function(e){return r(e),delete c[a],null}),o.emit("I_HAVE_A_REQUEST",i)}();if("object"===("undefined"==typeof i?"undefined":(0,a["default"])(i)))return i.v}catch(f){console.log(f),u(f)}})},n.connect=function(){var e=arguments.length<=0||void 0===arguments[0]?{}:arguments[0];if(n.state.isStarted)return!1;console.log(e);var t=n,r=n,a=r.handleRequest,o=(0,w["default"])(e.url);n.setState({opts:e,appId:e.key.appId,isStarted:!0,socket:o}),o.on("connect",function(){console.log("connected"),console.log("start register"),t.setState({isOnline:!0}),o.emit("REGISTER",e.key)}),o.on("YOUR_REGISTER_HAS_RESPONSE",function(e){t.setState({isRegistered:!0})}),o.on("YOUR_REQUEST_HAS_RESPONSE",function(e){var r=n.state.importEmitterStack,a=e.headers.callbackId;r[a].emit("RESPONSE",e),delete r[a],t.setState({importEmitterStack:r})}),o.on("PLEASE_HANDLE_THIS_REQUEST",a),o.on("disconnect",function(){console.log("disconnected"),t.setState({isOnline:!1})})},o=r,(0,x["default"])(n,o)}return(0,b["default"])(t,e),t}(g["default"]);exports["default"]=A,e.exports=exports["default"]},function(e,exports){e.exports=require("babel-runtime/helpers/typeof")},function(e,exports){e.exports=require("babel-runtime/core-js/promise")},function(e,exports){e.exports=require("babel-runtime/regenerator")},function(e,exports){e.exports=require("babel-runtime/core-js/json/stringify")},function(e,exports){e.exports=require("babel-runtime/helpers/asyncToGenerator")},function(e,exports){e.exports=require("babel-runtime/core-js/object/get-prototype-of")},function(e,exports){e.exports=require("babel-runtime/helpers/classCallCheck")},function(e,exports){e.exports=require("babel-runtime/helpers/possibleConstructorReturn")},function(e,exports){e.exports=require("babel-runtime/helpers/inherits")},function(e,exports){e.exports=require("uuid")},function(e,exports){e.exports=require("socket.io-client")},function(e,exports,t){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}Object.defineProperty(exports,"__esModule",{value:!0});var n=t(7),a=r(n),o=t(8),u=r(o),c=t(9),s=r(c),i=t(10),l=r(i),f=t(14),d=r(f),p=t(16),h=r(p),v=function(e){function t(){var e,r,n,o;(0,u["default"])(this,t);for(var c=arguments.length,i=Array(c),l=0;c>l;l++)i[l]=arguments[l];return r=n=(0,s["default"])(this,(e=(0,a["default"])(t)).call.apply(e,[this].concat(i))),n.exportActionStack=[],n.use=function(e,t){var r=n,a=r.exportActionStack,o={path:e,isErrorHandle:!1};t instanceof Function?(o.isErrorHandle=(0,h["default"])(t),o.fn=t):o.router=t,a.push(o)},n.handleLoop=function(e,t,r,a,o){function u(e){function n(n,a){console.log("run");try{return"error"==n?a.fn(e,t,r,u):"router"==n?a.router.handleLoop(e,t,r,u,i):a.fn(t,r,u)}catch(o){console.log(o),o&&u(o)}}if(i++,i>=s.length)return e&&console.error(e),a(e,t,r,a,o);var c=s[i];if(console.log("seashell: handle err"),c.isErrorHandle&&e)return n("error",c);if(e)return u(e);if(console.log("seashell: handle router"),c.router)return n("router",c);if(console.log("seashell: handle normal"),"undefined"!=typeof c.path){if(c.path!=t.headers.originUrl)return u();n(null,c)}}var c=n,s=c.exportActionStack,i=-1;u(e)},o=r,(0,s["default"])(n,o)}return(0,l["default"])(t,e),t}(d["default"]);exports["default"]=v,e.exports=exports["default"]},function(e,exports,t){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}Object.defineProperty(exports,"__esModule",{value:!0});var n=t(8),a=r(n),o=t(15),u=r(o),c=function s(){var e=this;(0,a["default"])(this,s),this.setState=function(t){e.state=(0,u["default"])(t,e.state)}};exports["default"]=c,e.exports=exports["default"]},function(e,exports){e.exports=require("lodash.defaults")},function(e,exports){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var t=function(e){try{return 4==e.toString().match(/[A-Z0-9a-z,(\s]*\)/)[0].split(",").length}catch(t){return!1}};exports["default"]=t,e.exports=exports["default"]},function(e,exports,t){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var r=t(18),n=t(19),a=function(){r.call(this)};n.inherits(a,r),exports["default"]=a,e.exports=exports["default"]},function(e,exports){e.exports=require("events")},function(e,exports){e.exports=require("util")},function(e,exports,t){"use strict";function r(e){return e&&e.__esModule?e:{"default":e}}Object.defineProperty(exports,"__esModule",{value:!0});var n=t(5),a=r(n),o=t(4),u=r(o),c=t(6),s=r(c),i=t(3),l=r(i),f=t(7),d=r(f),p=t(8),h=r(p),v=t(9),S=r(v),E=t(10),x=r(E),m=t(14),b=r(m),_=t(21),k=r(_),I=t(22),w=r(I),R=t(23),g=r(R),y=t(24),O=r(y),A=t(25),q=r(A),N=t(26),P=r(N),T=t(27),H=r(T),F=function(e){function t(){var e,r,n,o,c=this;(0,h["default"])(this,t);for(var i=arguments.length,f=Array(i),p=0;i>p;p++)f[p]=arguments[p];return r=n=(0,S["default"])(this,(e=(0,d["default"])(t)).call.apply(e,[this].concat(f))),n.state={},n.checkServiceFormat=function(e){return new l["default"](function(){var t=(0,s["default"])(u["default"].mark(function r(t,n){return u["default"].wrap(function(r){for(;;)switch(r.prev=r.next){case 0:if("string"==typeof e.appSecret){r.next=2;break}return r.abrupt("return",n("Service Defination Format Error"));case 2:if("string"==typeof e.appName){r.next=4;break}return r.abrupt("return",n("Service Defination Format Error"));case 4:t(!0);case 5:case"end":return r.stop()}},r,c)}));return function(e,r){return t.apply(this,arguments)}}())},n.addNewServiceByFilePath=function(){var e=(0,s["default"])(u["default"].mark(function t(e){var r,a,o,s,i;return u["default"].wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(t.prev=0,".json"===w["default"].extname(e)){t.next=3;break}throw new Error("file extname must be `json`!");case 3:return r=n,a=r.checkServiceFormat,o=n.state.Service,t.next=8,g["default"].readFile(e,"UTF-8");case 8:if(s=t.sent,i=JSON.parse(s),i.appId=w["default"].basename(e,".json"),i.socketId=null,i.online=0,a(i)){t.next=15;break}throw new Error("Service Defination Format Error");case 15:return t.next=17,o.insert(i);case 17:t.next=22;break;case 19:t.prev=19,t.t0=t["catch"](0),console.error(t.t0);case 22:case"end":return t.stop()}},t,c,[[0,19]])}));return function(t){return e.apply(this,arguments)}}(),n.updateServiceByFilePath=function(){var e=(0,s["default"])(u["default"].mark(function t(e){var r,a,o,s,i,l;return u["default"].wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,r=n.state.Service,a=n,o=a.checkServiceFormat,s=g["default"].readFile(e,"UTF-8"),i=JSON.parse(s),l=w["default"].basename(e,".json"),i.socketId=null,i.online=0,t.next=11,o(i);case 11:if(t.sent){t.next=13;break}throw Error("Service Defination Format Error");case 13:return t.next=15,r.update({appId:l},{$set:i},{});case 15:t.next=20;break;case 17:t.prev=17,t.t0=t["catch"](0),console.error(t.t0);case 20:case"end":return t.stop()}},t,c,[[0,17]])}));return function(t){return e.apply(this,arguments)}}(),n.removeServiceByFilePath=function(){var e=(0,s["default"])(u["default"].mark(function t(e){var r,a;return u["default"].wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return r=n.state.Service,a=w["default"].basename(e,".json"),t.next=4,r.remove({appId:a},{});case 4:case"end":return t.stop()}},t,c)}));return function(t){return e.apply(this,arguments)}}(),n.empty=(0,s["default"])(u["default"].mark(function v(){var e;return u["default"].wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,e=n.state.Service,t.next=4,e.remove({},{multi:!0});case 4:t.next=9;break;case 6:t.prev=6,t.t0=t["catch"](0),console.error(t.t0);case 9:case"end":return t.stop()}},v,c,[[0,6]])})),n.handleRequest=function(){var e=(0,s["default"])(u["default"].mark(function t(e,r){var o,s,i,l,f,d,p;return u["default"].wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(o=n.state,s=o.Service,i=o.io,console.log("import:"+(0,a["default"])(r)),r.headers.callbackId){t.next=6;break}throw new Error("LOST_CALLBACKID");case 6:return l={headers:{callbackId:r.headers.callbackId},body:{}},t.prev=7,f=r.headers.importAppName,t.next=11,s.findOne({socketId:e.id});case 11:if(d=t.sent){t.next=14;break}throw new Error("PERMISSION_DENIED");case 14:return t.next=16,s.findOne({online:1,appName:f});case 16:if(p=t.sent){t.next=19;break}throw new Error("TARGET_SERVICE_OFFLINE");case 19:i.sockets.connected[p.socketId].emit("PLEASE_HANDLE_THIS_REQUEST",r),console.log("\n         hub emit client '"+f+"' to handle request '"+r.headers.originUrl+"'\n      "),t.next=28;break;case 23:return t.prev=23,t.t0=t["catch"](7),console.log(t.t0),l.body={error:t.t0},t.abrupt("return",e.emit("YOUR_REQUEST_HAS_RESPONSE",l));case 28:case"end":return t.stop()}},t,c,[[7,23]])}));return function(t,r){return e.apply(this,arguments)}}(),n.handleResponse=function(){var e=(0,s["default"])(u["default"].mark(function t(e,r){var a,o,s,i,l;return u["default"].wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(a=n.state,o=a.Service,s=a.io,e.prev=3,r.headers.appId){e.next=6;break}throw new Error("Export Lost Params: [appId]");case 6:if(r.headers.callbackId){e.next=8;break}throw new Error("Export Lost Params: [callbackId]");case 8:return e.next=10,o.findOne({appId:r.headers.appId});case 10:i=e.sent,l=s.sockets.connected[i.socketId],l&&l.emit("YOUR_REQUEST_HAS_RESPONSE",r),e.next=18;break;case 15:e.prev=15,e.t0=e["catch"](3),console.error(e.t0);case 18:case"end":return e.stop()}},t,c,[[3,15]])}));return function(t,r){return e.apply(this,arguments)}}(),n.handleRegister=function(){var e=(0,s["default"])(u["default"].mark(function t(e,r){var a,o,s;return u["default"].wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(a=n.state.Service,t.prev=1,console.log("register"),console.log(r),console.log(e.id),e.id){t.next=7;break}throw new Error("LOST_SOCKET_ID");case 7:return o={online:1,appId:r.appId,socketId:e.id,appSecret:r.appSecret},t.next=10,a.findOne({appId:o.appId,appSecret:o.appSecret});case 10:if(s=t.sent){t.next=13;break}throw new Error("PERMISSION_DENIED");case 13:return t.next=15,a.update({appId:o.appId},{$set:o},{});case 15:e.emit("YOUR_REGISTER_HAS_RESPONSE",{success:1}),t.next=21;break;case 18:t.prev=18,t.t0=t["catch"](1),e.emit("YOUR_REGISTER_HAS_RESPONSE",{error:t.t0});case 21:case"end":return t.stop()}},t,c,[[1,18]])}));return function(t,r){return e.apply(this,arguments)}}(),n.start=function(){var e=(0,s["default"])(u["default"].mark(function t(){var e,r,a,o,i,l=arguments.length<=0||void 0===arguments[0]?{}:arguments[0];return u["default"].wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(!n.state.isStarted){t.next=2;break}return t.abrupt("return",!1);case 2:return e=n,r=n,a=r.addNewServiceByFilePath,o=r.updateServiceByFilePath,i=r.removeServiceByFilePath,l.port=l.port||3311,t.prev=8,t.delegateYield(u["default"].mark(function f(){var t,r,n;return u["default"].wrap(function(f){for(;;)switch(f.prev=f.next){case 0:return t=new P["default"]({filename:"data/db/Service.db",autoload:!0}),r=(0,H["default"])(),e.setState({Service:t,io:r,opts:l}),O["default"].sync("data/service"),f.next=6,e.empty();case 6:return f.next=8,(0,k["default"])("data/service/**/*.json",{});case 8:n=f.sent,n.length||console.warn("none service defination file found"),n.forEach(function(e){a(e)}),q["default"].createMonitor("data/service",function(e){e.on("created",a),e.on("changed",o),e.on("removed",i)}),r.on("connection",function(r){console.log("new connection "+r.id),r.on("REGISTER",function(t){e.handleRegister(r,t)}),r.on("I_HAVE_A_REQUEST",function(t){e.handleRequest(r,t)}),r.on("I_HAVE_HANDLE_THIS_REQUEST",function(t){e.handleResponse(r,t)}),r.on("disconnect",(0,s["default"])(u["default"].mark(function n(){return u["default"].wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return console.log(r.id+" disconnected"),e.next=3,t.update({socketId:r.id},{$set:{socketId:null,online:0}},{});case 3:case"end":return e.stop()}},n,c)})))}),console.log("listening on port "+l.port),r.listen(l.port);case 15:case"end":return f.stop()}},f,c)})(),"t0",10);case 10:t.next=15;break;case 12:throw t.prev=12,t.t1=t["catch"](8),t.t1;case 15:case"end":return t.stop()}},t,c,[[8,12]])}));return function(t){return e.apply(this,arguments)}}(),o=r,(0,S["default"])(n,o)}return(0,x["default"])(t,e),t}(b["default"]);exports["default"]=F,e.exports=exports["default"]},function(e,exports){e.exports=require("glob-promise")},function(e,exports){e.exports=require("path")},function(e,exports){e.exports=require("fs-promise")},function(e,exports){e.exports=require("mkdirp")},function(e,exports){e.exports=require("watch")},function(e,exports){e.exports=require("nedb-promise")},function(e,exports){e.exports=require("socket.io")}]);